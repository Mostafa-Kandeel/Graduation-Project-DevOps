---
- name: Deploy Application on EC2
  hosts: web
  become: true

  vars:
    aws_region: "{{ aws_region | default('us-east-1') }}"
    aws_account_id: "{{ aws_account_id }}"
    ecr_repo: my-app-repo
    image_tag: "{{ image_tag | default('latest') }}"
    container_name: my-app-container
    container_port: 90

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
    - name: Install Docker using official script (recommended)
      shell: |
        # تثبيت Docker بدون استخدام apt repository
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        rm -f get-docker.sh
      args:
        creates: /usr/bin/docker

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    # ===== الخطوة 3: الآن يمكن تثبيت AWS CLI =====
    - name: Update apt cache (fresh)
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install AWS CLI
      apt:
        name: awscli
        state: present
        update_cache: yes

    # ===== الخطوة 4: باقي المهام =====
    - name: Test Docker and AWS CLI
      shell: |
        echo "Docker: $(docker --version)"
        echo "AWS CLI: $(aws --version 2>/dev/null || echo 'Not installed')"
      register: versions
      changed_when: false
      
    - name: Start Docker service
      systemd:
        name: docker
        state: started
        enabled: true

    # IMPORTANT: Replaced docker_login with shell command that runs on remote EC2
    - name: Login to Amazon ECR using IAM Role
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | \
        docker login --username AWS --password-stdin {{ aws_account_id }}.dkr.ecr.{{ aws_region }}.amazonaws.com
      register: ecr_login_result
      changed_when: "'Login Succeeded' in ecr_login_result.stdout"
      # no_log: true  # Uncomment to hide credentials from logs

    - name: Debug - Show ECR login result
      debug:
        msg: "ECR Login: {{ ecr_login_result.stdout }}"
      when: ecr_login_result.failed

    - name: Pull Docker image from ECR
      docker_image:
        name: "{{ aws_account_id }}.dkr.ecr.{{ aws_region }}.amazonaws.com/{{ ecr_repo }}"
        tag: "{{ image_tag }}"
        source: pull
        force_source: yes

    - name: Stop and remove old container if exists
      docker_container:
        name: "{{ container_name }}"
        state: absent
        force_kill: yes
      ignore_errors: yes

    - name: Run new Docker container
      docker_container:
        name: "{{ container_name }}"
        image: "{{ aws_account_id }}.dkr.ecr.{{ aws_region }}.amazonaws.com/{{ ecr_repo }}:{{ image_tag }}"
        state: started
        restart_policy: always
        ports:
          - "8080:{{ container_port }}"
          
    - name: Verify container is running
      command: docker ps --filter "name={{ container_name }}" --format 'table {{ "{{" }}.Names{{ "}}" }}\t{{ "{{" }}.Status{{ "}}" }}'
      register: container_status
    
    - name: Show deployment status
      debug:
        msg: |
          Container status:
          {{ container_status.stdout_lines | join('\n') }}
